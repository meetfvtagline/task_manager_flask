{% extends "base.html" %}
{% block content %}

<h3>Dashboard</h3>

<div class="counts">
    <strong>Pending:</strong> {{ counts.pending }} |
    <strong>In Progress:</strong> {{ counts.in_progress }} |
    <strong>Completed:</strong> {{ counts.completed }}
</div>

<form id="addForm">
    <input name="title" placeholder="Title" required>
    <textarea name="description" placeholder="Description" required></textarea>
    <button type="submit" class="btn">Add Task</button>
</form>

<hr>

<div class="task-sections">
{% for status, label in [('pending','Pending'),('in-progress','In Progress'),('completed','Completed')] %}
<div class="task-column">
<h3>{{ label }}</h3>

{% for task in tasks if task.status == status %}
<div class="task" data-id="{{ task.id }}">

    <input class="title" value="{{ task.title }}">
    <textarea class="desc">{{ task.description }}</textarea>

    <!-- AUTO SAVE ON CHANGE -->
    <select class="status" onchange="saveTask({{ task.id }})">
        <option value="pending" {% if task.status=='pending' %}selected{% endif %}>Pending</option>
        <option value="in-progress" {% if task.status=='in-progress' %}selected{% endif %}>In Progress</option>
        <option value="completed" {% if task.status=='completed' %}selected{% endif %}>Completed</option>
    </select>

    <div style="margin-top:6px">
        <button type="button" class="btn" onclick="saveTask({{ task.id }})">Save</button>
        <button type="button" class="btn" onclick="deleteTask({{ task.id }})">Delete</button>
    </div>

</div>
{% endfor %}
</div>
{% endfor %}
</div>

<script>
document.getElementById("addForm").onsubmit = async e => {
    e.preventDefault();
    await fetch("/tasks/add", {
        method:"POST",
        body:new FormData(e.target)
    });
    location.reload();
};

async function saveTask(id){
    const box = document.querySelector(`[data-id='${id}']`);
    if(!box) return;

    const fd = new FormData();
    fd.append("title", box.querySelector(".title").value);
    fd.append("description", box.querySelector(".desc").value);
    fd.append("status", box.querySelector(".status").value);

    const res = await fetch(`/tasks/update/${id}`, {
        method:"POST",
        body:fd
    });

    if(res.ok) location.reload();
}

async function deleteTask(id){
    if(!confirm("Delete task?")) return;
    await fetch(`/tasks/delete/${id}`, { method:"POST" });
    location.reload();
}
</script>

{% endblock %}
