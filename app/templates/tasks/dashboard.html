{% extends "base.html" %}
{% block content %}

<div class="dashboard-layout">
    <div class="stats-bar">
        <div class="stat-card">
            <span class="stat-label">Pending</span>
            <span class="stat-value" style="color: var(--warning)">{{ counts.pending }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">In Progress</span>
            <span class="stat-value" style="color: var(--primary)">{{ counts.in_progress }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Completed</span>
            <span class="stat-value" style="color: var(--success)">{{ counts.completed }}</span>
        </div>
    </div>

    <div class="card mb-4">
        <h4 style="margin-bottom: 1rem;">Add New Task</h4>
        <form id="addForm" style="display: grid; gap: 1rem; grid-template-columns: 1fr 2fr auto; align-items: start;">
            <input name="title" placeholder="Task Title" required>
            <textarea name="description" placeholder="Task Description" required rows="1"
                style="height: 42px; padding-top: 10px;"></textarea>
            <button type="submit" class="btn btn-primary" style="height: 42px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Task
            </button>
        </form>
    </div>

    <div class="task-board">
        {% for status, label in [('pending','Pending'),('in-progress','In Progress'),('completed','Completed')] %}
        <div class="task-column">
            <div class="column-header">
                {{ label }}
                <span class="badge badge-count">
                    {% set count = 0 %}
                    {% for task in tasks if task.status == status %}{% set count = count + 1 %}{% endfor -%}
                    {{ namespace(val=0).val + (tasks|selectattr("status", "equalto", status)|list|length) }}
                </span>
            </div>

            {% for task in tasks if task.status == status %}
            <div class="task-card" data-id="{{ task.id }}">
                <input class="title task-input-title" value="{{ task.title }}">
                <textarea class="desc task-textarea-desc"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">{{ task.description }}</textarea>

                <div class="task-actions">
                    <select class="status task-status-select form-select" onchange="saveTask({{ task.id }})"
                        style="border-color: {% if task.status == 'completed' %}var(--success){% elif task.status == 'in-progress' %}var(--primary){% else %}var(--warning){% endif %}; color: inherit;">
                        <option value="pending" {% if task.status=='pending' %}selected{% endif %}>Pending</option>
                        <option value="in-progress" {% if task.status=='in-progress' %}selected{% endif %}>In Progress
                        </option>
                        <option value="completed" {% if task.status=='completed' %}selected{% endif %}>Completed
                        </option>
                    </select>

                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-outline btn-icon" onclick="saveTask({{ task.id }})"
                            title="Save Changes">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </button>
                        <button type="button" class="btn btn-danger btn-icon" onclick="deleteTask({{ task.id }})"
                            title="Delete Task">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if (tasks|selectattr("status", "equalto", status)|list|length) == 0 %}
            <div
                style="text-align: center; color: var(--text-muted); padding: 2rem; font-size: 0.9rem; font-style: italic;">
                No tasks
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.getElementById("addForm").onsubmit = async e => {
        e.preventDefault();
        await fetch("/tasks/add", {
            method: "POST",
            body: new FormData(e.target)
        });
        location.reload();
    };

    async function saveTask(id) {
        const box = document.querySelector(`[data-id='${id}']`);
        if (!box) return;

        const fd = new FormData();
        fd.append("title", box.querySelector(".title").value);
        fd.append("description", box.querySelector(".desc").value);
        fd.append("status", box.querySelector(".status").value);

        // Show loading state could be nice here, but keeping it simple as requested
        const res = await fetch(`/tasks/update/${id}`, {
            method: "POST",
            body: fd
        });

        if (res.ok) location.reload();
    }

    async function deleteTask(id) {
        if (!confirm("Are you sure you want to delete this task?")) return;
        await fetch(`/tasks/delete/${id}`, { method: "POST" });
        location.reload();
    }
</script>

{% endblock %}